---
- name: Finalization (MetalLB + ingress-nginx + Dashboard + Istio)
  hosts: all
  become: true
  gather_facts: true

  vars:
    kubeconfig_path: /etc/kubernetes/admin.conf
    venv_path: /home/vagrant/ansible_venv
    istio_version: "1.25.2"

  pre_tasks:
    - name: Install system packages for venv + pip + istio deps
      ansible.builtin.apt:
        name:
          - python3
          - python3-venv
          - python3-pip
          - curl
          - tar
        state: present
        update_cache: yes

    - name: Create virtualenv for Ansible Kubernetes modules
      ansible.builtin.command: python3 -m venv {{ venv_path }}
      args:
        creates: "{{ venv_path }}/bin/python"

    - name: Install Kubernetes Python deps into venv
      ansible.builtin.pip:
        name:
          - kubernetes
          - PyYAML
          - jsonpatch
        virtualenv: "{{ venv_path }}"
        virtualenv_command: "python3 -m venv"

    - name: Use venv python for subsequent tasks
      ansible.builtin.set_fact:
        ansible_python_interpreter: "{{ venv_path }}/bin/python"

  tasks:

    # Step 20 - MetalLB
    - name: Check number of nodes (single node cluster?)
      ansible.builtin.command: >
        kubectl get nodes --kubeconfig={{ kubeconfig_path }} --no-headers
      register: nodes_list
      changed_when: false

    - name: Remove control-plane taint (only on single-node cluster)
      ansible.builtin.command: >
        kubectl taint nodes --all node-role.kubernetes.io/control-plane- --kubeconfig={{ kubeconfig_path }}
      when: (nodes_list.stdout_lines | length) == 1
      register: taint_removal
      failed_when: false
      changed_when: "'untainted' in (taint_removal.stdout | lower)"

    - name: Copy MetalLB manifest to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/metallb/metallb-native.yaml"
        dest: /tmp/metallb-native.yaml
        mode: "0644"

    - name: Apply MetalLB manifest
      kubernetes.core.k8s:
        state: present
        src: /tmp/metallb-native.yaml
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Wait for MetalLB controller deployment to be available
      ansible.builtin.command: >
        kubectl wait --for=condition=available deployment/controller
        -n metallb-system --timeout=180s --kubeconfig={{ kubeconfig_path }}
      changed_when: false

    - name: Wait for MetalLB speaker daemonset rollout
      ansible.builtin.command: >
        kubectl rollout status daemonset/speaker
        -n metallb-system --timeout=180s --kubeconfig={{ kubeconfig_path }}
      changed_when: false

    - name: Copy MetalLB IPAddressPool to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/metallb/ip-pool.yaml"
        dest: /tmp/ip-pool.yaml
        mode: "0644"

    - name: Apply MetalLB IPAddressPool
      kubernetes.core.k8s:
        state: present
        src: /tmp/ip-pool.yaml
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Copy MetalLB L2Advertisement to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/metallb/l2-advertisement.yaml"
        dest: /tmp/l2-advertisement.yaml
        mode: "0644"

    - name: Apply MetalLB L2Advertisement
      kubernetes.core.k8s:
        state: present
        src: /tmp/l2-advertisement.yaml
        kubeconfig: "{{ kubeconfig_path }}"


    # Step 21 - ingress-nginx
    - name: Add ingress-nginx helm repo
      kubernetes.core.helm_repository:
        name: ingress-nginx
        repo_url: https://kubernetes.github.io/ingress-nginx

    - name: Copy ingress-nginx values.yaml to VM
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/ingress-nginx/values.yaml"
        dest: /tmp/ingress-values.yaml
        mode: "0644"

    - name: Install/upgrade ingress-nginx via Helm
      kubernetes.core.helm:
        name: ingress-nginx
        chart_ref: ingress-nginx/ingress-nginx
        release_namespace: ingress-nginx
        create_namespace: true
        values_files:
          - /tmp/ingress-values.yaml
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        wait: true
        wait_timeout: 300s

    - name: Wait for ingress-nginx controller rollout
      ansible.builtin.command: >
        kubectl rollout status deployment/ingress-nginx-controller
        -n ingress-nginx --timeout=180s --kubeconfig={{ kubeconfig_path }}
      changed_when: false


    # Step 22 - Kubernetes Dashboard
    - name: Add kubernetes-dashboard helm repo
      kubernetes.core.helm_repository:
        name: kubernetes-dashboard
        repo_url: https://kubernetes.github.io/dashboard/

    - name: Install/upgrade Kubernetes Dashboard via Helm
      kubernetes.core.helm:
        name: kubernetes-dashboard
        chart_ref: kubernetes-dashboard/kubernetes-dashboard
        release_namespace: kubernetes-dashboard
        create_namespace: true
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        values:
          fullnameOverride: kubernetes-dashboard
        wait: true
        wait_timeout: 300s

    - name: Copy Dashboard admin-user
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/dashboard/admin-user.yaml"
        dest: /tmp/dashboard-admin-user.yaml
        mode: "0644"

    - name: Copy Dashboard ingress
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/dashboard/ingress.yaml"
        dest: /tmp/dashboard-ingress.yaml
        mode: "0644"

    - name: Apply Dashboard admin-user
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        src: /tmp/dashboard-admin-user.yaml

    - name: Apply Dashboard ingress
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        src: /tmp/dashboard-ingress.yaml


    # Step 23 - Istio
    - name: Create Istio working directory
      ansible.builtin.file:
        path: /home/vagrant/istio
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Download Istio (amd64)
      ansible.builtin.get_url:
        url: "https://github.com/istio/istio/releases/download/{{ istio_version }}/istio-{{ istio_version }}-linux-amd64.tar.gz"
        dest: "/home/vagrant/istio/istio-{{ istio_version }}-linux-amd64.tar.gz"
        owner: vagrant
        group: vagrant
        mode: "0644"
      when: ansible_facts['architecture'] in ["x86_64", "amd64"]

    - name: Download Istio (arm64)
      ansible.builtin.get_url:
        url: "https://github.com/istio/istio/releases/download/{{ istio_version }}/istio-{{ istio_version }}-linux-arm64.tar.gz"
        dest: "/home/vagrant/istio/istio-{{ istio_version }}-linux-arm64.tar.gz"
        owner: vagrant
        group: vagrant
        mode: "0644"
      when: ansible_facts['architecture'] in ["aarch64", "arm64"]

    - name: Extract istioctl (amd64)
      ansible.builtin.unarchive:
        src: "/home/vagrant/istio/istio-{{ istio_version }}-linux-amd64.tar.gz"
        dest: /usr/local/bin
        remote_src: true
        extra_opts:
          - --strip-components=2
          - "istio-{{ istio_version }}/bin/istioctl"
      when: ansible_facts['architecture'] in ["x86_64", "amd64"]

    - name: Extract istioctl (arm64)
      ansible.builtin.unarchive:
        src: "/home/vagrant/istio/istio-{{ istio_version }}-linux-arm64.tar.gz"
        dest: /usr/local/bin
        remote_src: true
        extra_opts:
          - --strip-components=2
          - "istio-{{ istio_version }}/bin/istioctl"
      when: ansible_facts['architecture'] in ["aarch64", "arm64"]

    - name: Ensure istioctl is executable
      ansible.builtin.file:
        path: /usr/local/bin/istioctl
        state: file
        mode: "0755"

    - name: Check if istiod deployment exists
      ansible.builtin.command: >
        kubectl get deployment istiod -n istio-system --kubeconfig={{ kubeconfig_path }}
      register: istiod_check
      failed_when: false
      changed_when: false

    - name: Install Istio (default profile)
      ansible.builtin.command: >
        istioctl install -y
      when: istiod_check.rc != 0

    - name: Wait for Istio control plane to be ready
      ansible.builtin.command: >
        kubectl -n istio-system wait --for=condition=available deployment/istiod
        --timeout=300s --kubeconfig={{ kubeconfig_path }}
      changed_when: false

    - name: Enable Istio sidecar injection for default namespace
      ansible.builtin.command: >
        kubectl label namespace default istio-injection=enabled --overwrite --kubeconfig={{ kubeconfig_path }}
      register: inject_label
      failed_when: false
      changed_when: false

    - name: Restart default namespace deployments so sidecars get injected
      ansible.builtin.command: >
        kubectl rollout restart deployment -n default --kubeconfig={{ kubeconfig_path }}
      failed_when: false
      changed_when: false
