---
- hosts: ctrl
  become: yes
  vars:
    flannel_version: "0.26.7"
    helm_version: "v3.13.2"

  tasks:
    - name: Install Controller Dependencies (Placeholder)
      debug:
        msg: "This is where Kubernetes Controller setup happens. add our logic here for step 13 and onward"

    # Step 13: Initialize Kubernetes Cluster
    - name: Check if Kubernetes cluster is already initialized
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: admin_conf_check

    - name: Initialize Kubernetes cluster with kubeadm
      ansible.builtin.command: >
        kubeadm init
        --apiserver-advertise-address=192.168.56.100
        --node-name=ctrl
        --pod-network-cidr=10.244.0.0/16
        --ignore-preflight-errors=NumCPU
      when: not admin_conf_check.stat.exists

    # Step 14: Setup kubectl
    - name: Create .kube directory for vagrant user
      ansible.builtin.file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy admin.conf to vagrant user's kube config
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        remote_src: yes
        owner: vagrant
        group: vagrant
        mode: '0600'

    - name: Fetch admin.conf to operation repo root
      ansible.builtin.fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ playbook_dir }}/../kubeconfig"
        flat: yes

    # Step 15: Create Pod network
    # Checks if flannel interface is already up to ensure idempotency.
    - name: Check if Flannel is already running
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf -n kube-flannel get ds kube-flannel-ds
      register: flannel_check
      failed_when: false
      changed_when: false

    - name: Configure and Install Flannel
      block:
        - name: Download Flannel manifest
          get_url:
            url: https://github.com/flannel-io/flannel/releases/download/v{{ flannel_version }}/kube-flannel.yml
            dest: /tmp/kube-flannel-original.yml
            mode: '0644'
        - name: Modify Flannel manifest to use eth1 interface
          ansible.builtin.shell: |
            cp /tmp/kube-flannel-original.yml /tmp/kube-flannel.yml
            sed -i '/--kube-subnet-mgr/a\        - --iface=eth1' /tmp/kube-flannel.yml
          args:
            creates: /tmp/kube-flannel.yml
        - name: Apply Flannel manifest
          command: kubectl apply -f /tmp/kube-flannel.yml
          environment:
            KUBECONFIG: /etc/kubernetes/admin.conf
      when: flannel_check.rc != 0

    # Step 16: Install Helm
    # Replaced Apt Repository method (slow) with direct binary script (fast).
    - name: Check if Helm is installed
      stat:
        path: /usr/local/bin/helm
      register: helm_bin

    - name: Install Helm (Script Method)
      shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      environment:
        VERIFY_CHECKSUM: "false"
      when: not helm_bin.stat.exists

    # Step 17: Install Helm package (helm-diff)
    - name: Check if helm-diff plugin is installed
      command: helm plugin list
      become: false # Run as vagrant user
      register: helm_plugin_list
      changed_when: false
      failed_when: false

    - name: Install helm-diff plugin
      command: helm plugin install https://github.com/databus23/helm-diff
      become: false # Run as vagrant user
      when: "'diff' not in helm_plugin_list.stdout"